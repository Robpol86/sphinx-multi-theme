name: CI

on:
  pull_request:
  push:

jobs:

  test:
    name: Test
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python: ["3.6", "3.7", "3.8", "3.9", "3.10"]
        exclude:
          - os: windows-latest
            python: "3.6"
    runs-on: "${{matrix.os}}"
    steps:
      - {name: Check out repository code, uses: actions/checkout@v2}
      - {name: Initialize dependencies, uses: Robpol86/actions-init-deps-py@v3, with: {python-version: "${{matrix.python}}"}}
      - {name: Run tests, run: make test, env: {PY_COLORS: 1}}
      - {name: Upload coverage, uses: codecov/codecov-action@v2, with: {name: "coverage-${{runner.os}}-${{matrix.python}}"}}
      - {name: Run lints, run: make lint}
      - {name: Run integration tests, run: make it}
      - {name: Build docs, run: make docs, if: "runner.os != 'Windows'"}
      - {name: Build package, run: make build && cd dist && unzip -t *.whl && unzip -p *.whl '*/METADATA'}
